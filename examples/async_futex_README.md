# AsyncFutex ç¤ºä¾‹è¯´æ˜

## æ¦‚è¿°

`async_futex_example.rs` å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `AsyncFutex` å¼‚æ­¥åŒæ­¥åŸè¯­ã€‚`AsyncFutex` æ˜¯åŸºäº Linux futex ç³»ç»Ÿè°ƒç”¨çš„é«˜æ€§èƒ½åŒæ­¥æœºåˆ¶ï¼Œä¸»è¦ç”¨äºè·¨è¿›ç¨‹åŒæ­¥åœºæ™¯ã€‚

## AsyncFutex æ ¸å¿ƒç‰¹æ€§

### ğŸ”§ æŠ€æœ¯æ¶æ„
- **åº•å±‚å®ç°**: åŸºäº Linux futex ç³»ç»Ÿè°ƒç”¨
- **å¼‚æ­¥æ”¯æŒ**: ç»“åˆ eventfd å®ç°å¼‚æ­¥é€šçŸ¥æœºåˆ¶
- **è·¨è¿›ç¨‹**: è®¾è®¡ç”¨äºå…±äº«å†…å­˜ç¯å¢ƒä¸‹çš„è¿›ç¨‹é—´åŒæ­¥
- **é«˜æ€§èƒ½**: ç›´æ¥ä½¿ç”¨å†…æ ¸åŒæ­¥åŸè¯­ï¼Œé¿å…ç”¨æˆ·æ€è½®è¯¢

### ğŸš€ ä¸»è¦ä¼˜åŠ¿
1. **é›¶æ‹·è´**: ç›´æ¥æ“ä½œå…±äº«å†…å­˜ä¸­çš„åŸå­å˜é‡
2. **ä½å»¶è¿Ÿ**: å†…æ ¸çº§åŒæ­¥ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
3. **å¼‚æ­¥å‹å¥½**: ä¸ Tokio å¼‚æ­¥è¿è¡Œæ—¶å®Œç¾é›†æˆ
4. **å¯æ‰©å±•**: æ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šåŒæ­¥æ¨¡å¼

## ä»£ç ç»“æ„åˆ†æ

### æ ¸å¿ƒç»„ä»¶

```rust
pub struct AsyncFutex {
    pub addr: *mut AtomicU32, // å…±äº«å†…å­˜ä¸­çš„ futex å˜é‡
    event_fd: AsyncFd<RawFd>, // å¼‚æ­¥é€šçŸ¥æœºåˆ¶
}
```

### å…³é”®æ–¹æ³•

#### 1. `new(addr: *mut AtomicU32)` - åˆ›å»ºå®ä¾‹
```rust
let futex = AsyncFutex::new(shared_memory_addr)?;
```

#### 2. `wait_async(expected: u32)` - å¼‚æ­¥ç­‰å¾…
```rust
// ç­‰å¾…å€¼å˜åŒ–
futex.wait_async(current_value).await?;
```

#### 3. `wake(n: u32)` - å”¤é†’ç­‰å¾…è€…
```rust
// å”¤é†’ä¸€ä¸ªç­‰å¾…è€…
futex.wake(1);

// å”¤é†’æ‰€æœ‰ç­‰å¾…è€…
futex.wake(u32::MAX);
```

## ç¤ºä¾‹è¯¦è§£

### ç¤ºä¾‹1: åŸºæœ¬ API ä½¿ç”¨
æ¼”ç¤º `AsyncFutex` çš„åŸºæœ¬åˆ›å»ºå’Œæ“ä½œï¼š
- åˆ›å»º futex å®ä¾‹
- ä¿®æ”¹å…±äº«å˜é‡å€¼
- å‘é€å”¤é†’ä¿¡å·

### ç¤ºä¾‹2: çŠ¶æ€å˜åŒ–æ¼”ç¤º
æ¨¡æ‹Ÿåº”ç”¨ç¨‹åºçŠ¶æ€æœºï¼š
- çŠ¶æ€è½¬æ¢åºåˆ—
- çŠ¶æ€å˜åŒ–é€šçŸ¥
- å¼‚æ­¥çŠ¶æ€ç›‘æ§

### ç¤ºä¾‹3: å”¤é†’æœºåˆ¶æ¼”ç¤º
å±•ç¤ºä¸åŒçš„å”¤é†’ç­–ç•¥ï¼š
- å•ä¸ªå”¤é†’ (`wake(1)`)
- æ‰¹é‡å”¤é†’ (`wake(n)`)
- å¹¿æ’­å”¤é†’ (`wake(u32::MAX)`)

## å®é™…åº”ç”¨åœºæ™¯

### 1. è·¨è¿›ç¨‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…
```rust
// ç”Ÿäº§è€…è¿›ç¨‹
shared_buffer.store(data, Ordering::SeqCst);
futex.wake(1); // é€šçŸ¥æ¶ˆè´¹è€…

// æ¶ˆè´¹è€…è¿›ç¨‹
futex.wait_async(empty_state).await?;
let data = shared_buffer.load(Ordering::SeqCst);
```

### 2. åˆ†å¸ƒå¼é”
```rust
// å°è¯•è·å–é”
loop {
    if lock_state.compare_exchange(0, 1, Ordering::SeqCst, Ordering::Relaxed).is_ok() {
        break; // è·å–æˆåŠŸ
    }
    futex.wait_async(1).await?; // ç­‰å¾…é”é‡Šæ”¾
}

// é‡Šæ”¾é”
lock_state.store(0, Ordering::SeqCst);
futex.wake(1); // é€šçŸ¥ç­‰å¾…è€…
```

### 3. äº‹ä»¶é€šçŸ¥ç³»ç»Ÿ
```rust
// äº‹ä»¶å‘å¸ƒè€…
event_counter.fetch_add(1, Ordering::SeqCst);
futex.wake(u32::MAX); // å¹¿æ’­é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…

// äº‹ä»¶è®¢é˜…è€…
let last_seen = event_counter.load(Ordering::SeqCst);
futex.wait_async(last_seen).await?;
// å¤„ç†æ–°äº‹ä»¶
```

## è¿è¡Œç¤ºä¾‹

```bash
# ç¼–è¯‘ç¤ºä¾‹
cargo build --bin async_futex_example

# è¿è¡Œç¤ºä¾‹
cargo run --bin async_futex_example
```

## æ³¨æ„äº‹é¡¹

### âš ï¸ å¹³å°é™åˆ¶
- ä»…æ”¯æŒ Linux ç³»ç»Ÿï¼ˆä¾èµ– futex ç³»ç»Ÿè°ƒç”¨ï¼‰
- éœ€è¦ WSL æˆ–åŸç”Ÿ Linux ç¯å¢ƒ

### ğŸ”’ çº¿ç¨‹å®‰å…¨
- `AsyncFutex` æœ¬èº«ä¸æ˜¯ `Send`ï¼Œå› ä¸ºåŒ…å«åŸå§‹æŒ‡é’ˆ
- é€‚ç”¨äºå•çº¿ç¨‹å¼‚æ­¥ç¯å¢ƒæˆ–ç‰¹å®šçš„è·¨è¿›ç¨‹åœºæ™¯
- å…±äº«å†…å­˜éœ€è¦æ­£ç¡®çš„å†…å­˜ç®¡ç†

### ğŸ¯ æœ€ä½³å®è·µ
1. **å†…å­˜ç®¡ç†**: ç¡®ä¿å…±äº«å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. **é”™è¯¯å¤„ç†**: å¦¥å–„å¤„ç†ç³»ç»Ÿè°ƒç”¨å¯èƒ½çš„å¤±è´¥
3. **æ€§èƒ½ä¼˜åŒ–**: é¿å…é¢‘ç¹çš„ wake æ“ä½œ
4. **è°ƒè¯•æ”¯æŒ**: ä½¿ç”¨æ—¥å¿—è®°å½•åŒæ­¥çŠ¶æ€å˜åŒ–

## ç›¸å…³èµ„æº

- [Linux futex æ‰‹å†Œ](https://man7.org/linux/man-pages/man2/futex.2.html)
- [Tokio AsyncFd æ–‡æ¡£](https://docs.rs/tokio/latest/tokio/io/unix/struct.AsyncFd.html)
- [Rust åŸå­æ“ä½œæŒ‡å—](https://doc.rust-lang.org/std/sync/atomic/)